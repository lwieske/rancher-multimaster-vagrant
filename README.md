# rancher-multimaster-vagrant

![](https://raw.githubusercontent.com/lwieske/rancher-multimaster-vagrant/master/demo800x600.gif)

Kubernetes Cluster: rancher mgmt plane + 3 master ctrl plane + (1+) worker data plane

## Vagrant Spin Up For 1 Manager + 3 Masters + (1+) Workers

### Rancher 2.2.4

```console
> clear
> ./rec.sh
+ rm -f demo.cast
+ asciinema rec -y -c 'bash -x run.sh' demo.cast
asciinema: recording asciicast to demo.cast
asciinema: exit opened program when you're done
+ set -x
+ vagrant destroy --force
Admin Username: admin
Admin Password: e838faa3f69f31ee
==> data01: Forcing shutdown of VM...
==> data01: Destroying VM and associated drives...
==> data01: [vagrant-hostmanager:guests] Updating hosts file on active guest virtual machines...
==> ctrl03: Forcing shutdown of VM...
==> ctrl03: Destroying VM and associated drives...
==> ctrl03: [vagrant-hostmanager:guests] Updating hosts file on active guest virtual machines...
==> ctrl02: Forcing shutdown of VM...
==> ctrl02: Destroying VM and associated drives...
==> ctrl02: [vagrant-hostmanager:guests] Updating hosts file on active guest virtual machines...
==> ctrl01: Forcing shutdown of VM...
==> ctrl01: Destroying VM and associated drives...
==> ctrl01: [vagrant-hostmanager:guests] Updating hosts file on active guest virtual machines...
==> mgmt01: Forcing shutdown of VM...
==> mgmt01: Destroying VM and associated drives...
==> mgmt01: [vagrant-hostmanager:guests] Updating hosts file on active guest virtual machines...
+ vagrant up
Admin Username: admin
Admin Password: 879c1035625753d3
Bringing machine 'mgmt01' up with 'virtualbox' provider...
Bringing machine 'ctrl01' up with 'virtualbox' provider...
Bringing machine 'ctrl02' up with 'virtualbox' provider...
Bringing machine 'ctrl03' up with 'virtualbox' provider...
Bringing machine 'data01' up with 'virtualbox' provider...
==> mgmt01: Importing base box 'docker-18.09.7'...
==> mgmt01: Matching MAC address for NAT networking...
==> mgmt01: Setting the name of the VM: rancher-multimaster-vagrant_mgmt01_1563439351039_32944
==> mgmt01: Clearing any previously set network interfaces...
==> mgmt01: Preparing network interfaces based on configuration...
    mgmt01: Adapter 1: nat
    mgmt01: Adapter 2: hostonly
==> mgmt01: Forwarding ports...
    mgmt01: 22 (guest) => 2222 (host) (adapter 1)
==> mgmt01: Running 'pre-boot' VM customizations...
==> mgmt01: Booting VM...
==> mgmt01: Waiting for machine to boot. This may take a few minutes...
    mgmt01: SSH address: 127.0.0.1:2222
    mgmt01: SSH username: vagrant
    mgmt01: SSH auth method: private key
==> mgmt01: Machine booted and ready!
[mgmt01] GuestAdditions 6.0.8 running --- OK.
==> mgmt01: Checking for guest additions in VM...
==> mgmt01: Setting hostname...
==> mgmt01: Configuring and enabling network interfaces...
==> mgmt01: Mounting shared folders...
    mgmt01: /vagrant => /Users/lothar/Documents/GitHub/rancher-multimaster-vagrant
==> mgmt01: [vagrant-hostmanager:guests] Updating hosts file on active guest virtual machines...
==> mgmt01: Running provisioner: shell...
    mgmt01: Running: inline script
    mgmt01: ***************************
    mgmt01: pulling images
    mgmt01: starting rancher
    mgmt01: waiting for rancher
    mgmt01: pong
    mgmt01: login to rancher
    mgmt01: logged in as admin/admin
    mgmt01: changed to 879c1035625753d3
    mgmt01: APITOKEN created
    mgmt01: Server URL configured
    mgmt01: CLUSTERID created
    mgmt01: REGISTRATIONTOKEN created
    mgmt01: ***************************
==> ctrl01: Importing base box 'docker-18.09.7'...
==> ctrl01: Matching MAC address for NAT networking...
==> ctrl01: Setting the name of the VM: rancher-multimaster-vagrant_ctrl01_1563439432023_7119
==> ctrl01: Fixed port collision for 22 => 2222. Now on port 2200.
==> ctrl01: Clearing any previously set network interfaces...
==> ctrl01: Preparing network interfaces based on configuration...
    ctrl01: Adapter 1: nat
    ctrl01: Adapter 2: hostonly
==> ctrl01: Forwarding ports...
    ctrl01: 22 (guest) => 2200 (host) (adapter 1)
==> ctrl01: Running 'pre-boot' VM customizations...
==> ctrl01: Booting VM...
==> ctrl01: Waiting for machine to boot. This may take a few minutes...
    ctrl01: SSH address: 127.0.0.1:2200
    ctrl01: SSH username: vagrant
    ctrl01: SSH auth method: private key
    ctrl01: Warning: Remote connection disconnect. Retrying...
    ctrl01: Warning: Connection reset. Retrying...
    ctrl01: Warning: Remote connection disconnect. Retrying...
    ctrl01: Warning: Connection reset. Retrying...
    ctrl01: Warning: Remote connection disconnect. Retrying...
==> ctrl01: Machine booted and ready!
[ctrl01] GuestAdditions 6.0.8 running --- OK.
==> ctrl01: Checking for guest additions in VM...
==> ctrl01: Setting hostname...
==> ctrl01: Configuring and enabling network interfaces...
==> ctrl01: Mounting shared folders...
    ctrl01: /vagrant => /Users/lothar/Documents/GitHub/rancher-multimaster-vagrant
==> ctrl01: [vagrant-hostmanager:guests] Updating hosts file on active guest virtual machines...
==> ctrl01: Running provisioner: shell...
    ctrl01: Running: inline script
    ctrl01: ***************************
    ctrl01: pulling images
    ctrl01: login to rancher
    ctrl01: creating CLUSTERID
    ctrl01: created CLUSTERID
    ctrl01: get agent command
    ctrl01: got agent command
    ctrl01: execute agent command
    ctrl01: sudo docker run -d --privileged --restart=unless-stopped --net=host -v /etc/kubernetes:/etc/kubernetes -v /var/run:/var/run rancher/rancher-agent:v2.2.4 --server https://mgmt01.local --token cjqqb4tw58ll2l2kkg4j2gh2jnwfxc8dnxv2s6jnh6h5zrg9ctlnrx --ca-checksum a0bc331e2f10e7bdc9ba2866590af4eb712a7da8be4d8e4f6615bf6d6d171b41 --etcd --controlplane --internal-address 10.10.10.101 --address 10.10.10.101
    ctrl01: executed agent command
    ctrl01: ***************************
==> ctrl02: Importing base box 'docker-18.09.7'...
==> ctrl02: Matching MAC address for NAT networking...
==> ctrl02: Setting the name of the VM: rancher-multimaster-vagrant_ctrl02_1563439508209_43183
==> ctrl02: Fixed port collision for 22 => 2222. Now on port 2201.
==> ctrl02: Clearing any previously set network interfaces...
==> ctrl02: Preparing network interfaces based on configuration...
    ctrl02: Adapter 1: nat
    ctrl02: Adapter 2: hostonly
==> ctrl02: Forwarding ports...
    ctrl02: 22 (guest) => 2201 (host) (adapter 1)
==> ctrl02: Running 'pre-boot' VM customizations...
==> ctrl02: Booting VM...
==> ctrl02: Waiting for machine to boot. This may take a few minutes...
    ctrl02: SSH address: 127.0.0.1:2201
    ctrl02: SSH username: vagrant
    ctrl02: SSH auth method: private key
==> ctrl02: Machine booted and ready!
[ctrl02] GuestAdditions 6.0.8 running --- OK.
==> ctrl02: Checking for guest additions in VM...
==> ctrl02: Setting hostname...
==> ctrl02: Configuring and enabling network interfaces...
==> ctrl02: Mounting shared folders...
    ctrl02: /vagrant => /Users/lothar/Documents/GitHub/rancher-multimaster-vagrant
==> ctrl02: [vagrant-hostmanager:guests] Updating hosts file on active guest virtual machines...
==> ctrl02: Running provisioner: shell...
    ctrl02: Running: inline script
    ctrl02: ***************************
    ctrl02: pulling images
    ctrl02: login to rancher
    ctrl02: creating CLUSTERID
    ctrl02: created CLUSTERID
    ctrl02: get agent command
    ctrl02: got agent command
    ctrl02: execute agent command
    ctrl02: sudo docker run -d --privileged --restart=unless-stopped --net=host -v /etc/kubernetes:/etc/kubernetes -v /var/run:/var/run rancher/rancher-agent:v2.2.4 --server https://mgmt01.local --token cjqqb4tw58ll2l2kkg4j2gh2jnwfxc8dnxv2s6jnh6h5zrg9ctlnrx --ca-checksum a0bc331e2f10e7bdc9ba2866590af4eb712a7da8be4d8e4f6615bf6d6d171b41 --etcd --controlplane --internal-address 10.10.10.102 --address 10.10.10.102
    ctrl02: executed agent command
    ctrl02: ***************************
==> ctrl03: Importing base box 'docker-18.09.7'...
==> ctrl03: Matching MAC address for NAT networking...
==> ctrl03: Setting the name of the VM: rancher-multimaster-vagrant_ctrl03_1563439579464_77983
==> ctrl03: Fixed port collision for 22 => 2222. Now on port 2202.
==> ctrl03: Clearing any previously set network interfaces...
==> ctrl03: Preparing network interfaces based on configuration...
    ctrl03: Adapter 1: nat
    ctrl03: Adapter 2: hostonly
==> ctrl03: Forwarding ports...
    ctrl03: 22 (guest) => 2202 (host) (adapter 1)
==> ctrl03: Running 'pre-boot' VM customizations...
==> ctrl03: Booting VM...
==> ctrl03: Waiting for machine to boot. This may take a few minutes...
    ctrl03: SSH address: 127.0.0.1:2202
    ctrl03: SSH username: vagrant
    ctrl03: SSH auth method: private key
==> ctrl03: Machine booted and ready!
[ctrl03] GuestAdditions 6.0.8 running --- OK.
==> ctrl03: Checking for guest additions in VM...
==> ctrl03: Setting hostname...
==> ctrl03: Configuring and enabling network interfaces...
==> ctrl03: Mounting shared folders...
    ctrl03: /vagrant => /Users/lothar/Documents/GitHub/rancher-multimaster-vagrant
==> ctrl03: [vagrant-hostmanager:guests] Updating hosts file on active guest virtual machines...
==> ctrl03: Running provisioner: shell...
    ctrl03: Running: inline script
    ctrl03: ***************************
    ctrl03: pulling images
    ctrl03: login to rancher
    ctrl03: creating CLUSTERID
    ctrl03: created CLUSTERID
    ctrl03: get agent command
    ctrl03: got agent command
    ctrl03: execute agent command
    ctrl03: sudo docker run -d --privileged --restart=unless-stopped --net=host -v /etc/kubernetes:/etc/kubernetes -v /var/run:/var/run rancher/rancher-agent:v2.2.4 --server https://mgmt01.local --token cjqqb4tw58ll2l2kkg4j2gh2jnwfxc8dnxv2s6jnh6h5zrg9ctlnrx --ca-checksum a0bc331e2f10e7bdc9ba2866590af4eb712a7da8be4d8e4f6615bf6d6d171b41 --etcd --controlplane --internal-address 10.10.10.103 --address 10.10.10.103
    ctrl03: executed agent command
    ctrl03: ***************************
==> data01: Importing base box 'docker-18.09.7'...
==> data01: Matching MAC address for NAT networking...
==> data01: Setting the name of the VM: rancher-multimaster-vagrant_data01_1563439643136_31209
==> data01: Fixed port collision for 22 => 2222. Now on port 2203.
==> data01: Clearing any previously set network interfaces...
==> data01: Preparing network interfaces based on configuration...
    data01: Adapter 1: nat
    data01: Adapter 2: hostonly
==> data01: Forwarding ports...
    data01: 22 (guest) => 2203 (host) (adapter 1)
==> data01: Running 'pre-boot' VM customizations...
==> data01: Booting VM...
==> data01: Waiting for machine to boot. This may take a few minutes...
    data01: SSH address: 127.0.0.1:2203
    data01: SSH username: vagrant
    data01: SSH auth method: private key
    data01: Warning: Connection reset. Retrying...
    data01: Warning: Remote connection disconnect. Retrying...
    data01: Warning: Connection reset. Retrying...
    data01: Warning: Remote connection disconnect. Retrying...
    data01: Warning: Remote connection disconnect. Retrying...
    data01: Warning: Connection reset. Retrying...
==> data01: Machine booted and ready!
[data01] GuestAdditions 6.0.8 running --- OK.
==> data01: Checking for guest additions in VM...
==> data01: Setting hostname...
==> data01: Configuring and enabling network interfaces...
==> data01: Mounting shared folders...
    data01: /vagrant => /Users/lothar/Documents/GitHub/rancher-multimaster-vagrant
==> data01: [vagrant-hostmanager:guests] Updating hosts file on active guest virtual machines...
==> data01: Running provisioner: shell...
    data01: Running: inline script
    data01: ***************************
    data01: pulling images
    data01: login to rancher
    data01: creating CLUSTERID
    data01: created CLUSTERID
    data01: get agent command
    data01: got agent command
    data01: execute agent command
    data01: sudo docker run -d --privileged --restart=unless-stopped --net=host -v /etc/kubernetes:/etc/kubernetes -v /var/run:/var/run rancher/rancher-agent:v2.2.4 --server https://mgmt01.local --token cjqqb4tw58ll2l2kkg4j2gh2jnwfxc8dnxv2s6jnh6h5zrg9ctlnrx --ca-checksum a0bc331e2f10e7bdc9ba2866590af4eb712a7da8be4d8e4f6615bf6d6d171b41 --worker --internal-address 10.10.10.201 --address 10.10.10.201
    data01: executed agent command
    data01: ***************************
asciinema: recording finished
asciinema: asciicast saved to demo.cast
> 
```